# Copyright (c) 2023 Huawei Device Co., Ltd.
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

# Contributor: baijn <1225837220@qq.com>
# Maintainer: baijn <1225837220@qq.com>

pkgname=libtorrent
pkgver=v2.0.10
pkgrel=0
pkgdesc="libtorrent is an open source C++ library implementing the BitTorrent protocol, along with most popular extensions, making it suitable for real world deployment. It is configurable to be able to fit both servers and embedded devices."
url="https://github.com/arvidn/libtorrent"
archs=("armeabi-v7a" "arm64-v8a")
license=("BSD-3-Clause")
depends=("boost")
makedepends=()
source="https://github.com/arvidn/$pkgname.git"
commitid=74bc93a37a5e31c78f0aa02037a68fb9ac5deb41

downloadpackage=false
autounpack=false
buildtools="cmake"
builddir=$pkgname-${pkgver:1}
packagename=
cloneflag=true

prepare() {
    if $cloneflag
    then
        git clone --recurse-submodules $source $builddir > $publicbuildlog 2>&1
        if [ $? -ne 0 ]
        then
            return -1
        fi
        cd $builddir
        git reset --hard $commitid >> $publicbuildlog 2>&1
        if [ $? -ne 0 ]
        then
            cd $OLDPWD
            return -2
        fi
        #test_copy_file测试用例中：1.添加鸿蒙对应的文件系统块魔数；2.预编译时添加文件系统稀疏文件偏移量的宏定义；
        #CMakeLists中：有16个测试用例涉及python脚本的调用，目前鸿蒙系统不支持，故屏蔽
        patch -p1 < `pwd`/../libtorrent_oh_pkg.patch >> $publicbuildlog 2>&1
        cd $OLDPWD
        cloneflag=false
    fi

    mkdir -p $builddir/$ARCH-build
}

build() {
    cd $builddir
    ${OHOS_SDK}/native/build-tools/cmake/bin/cmake "$@" \
        -DBUILD_SHARED_LIBS=OFF \
        -Dbuild_tests=ON \
        -B$ARCH-build -S./ > $buildlog 2>&1
    $MAKE VERBOSE=1 -C $ARCH-build >> $buildlog 2>&1
    ret=$?
    cd $OLDPWD
    return $ret
}

package() {
    cd $builddir
    $MAKE -C $ARCH-build install >> $buildlog 2>&1
    ret=$?
    cd $OLDPWD
    return $ret
}

check() {
    echo "The test must be on an OpenHarmony device!"
}

cleanbuild() {
    rm -rf ${PWD}/$builddir #${PWD}/$packagename
}
